/**
 * RPG Adventure - 資料庫與數值平衡檔 (v29 - Fix Job Tree & Scaling)
 * 包含：靜態資料 (DB) 與 成長公式 (Math)
 */

// === 遊戲常數 ===
const MAX_HELPER_LV = 150;        // 助手等級上限
const PLAYER_ATK_INTERVAL = 3000; // 主角自動攻擊間隔 (ms)
const CLICK_CPS_RATIO = 5;        // DPS計算用的模擬點擊頻率 (次/秒)
// 背景圖連結 (若失效會顯示深色背景)
const BG_IMAGE_URL = "https://upload.wikimedia.org/wikipedia/commons/e/e0/Creek_and_old-growth_forest-Larch_Mountain.jpg";

// === [區塊 1] 靜態資料庫 ===

const SERIES_DB = {
    "MAPLE": "楓葉系列",
    "RO": "仙境系列"
};

// 楓葉系列職業樹 (依照圖片順序修正)
// 結構: Camp -> Group -> Tier: [Branch A, Branch B, Branch C...]
// 注意：Index 0 對應 Branch A，Index 1 對應 Branch B，以此類推
const JOB_MAPLE = {
    "冒險家": {
        "劍士": { 
            1: "劍士", 
            2: ["狂戰士", "見習騎士", "槍騎兵"], 
            3: ["十字軍", "騎士", "龍騎士"], 
            4: ["英雄", "聖騎士", "黑騎士"] 
        },
        "法師": { 
            1: "法師", 
            2: ["火毒巫師", "冰雷巫師", "僧侶"], // 修正順序：火毒 -> 冰雷 -> 僧侶
            3: ["火毒魔導士", "冰雷魔導士", "祭司"], 
            4: ["火毒大魔導士", "冰雷大魔導士", "主教"] 
        },
        "弓箭手": { 
            1: "弓箭手", 
            2: ["獵人", "弩弓手"], 
            3: ["遊俠", "狙擊手"], 
            4: ["箭神", "神射手"] 
        },
        "盜賊": { 
            1: "盜賊", 
            2: ["刺客", "俠盜"], 
            3: ["暗殺者", "神偷"], // 修正名稱
            4: ["夜使者", "暗影神偷"] 
        },
        "海盜": { 
            1: "海盜", 
            2: ["槍手", "打手"], 
            3: ["神槍手", "格鬥家"], // 修正名稱
            4: ["槍神", "拳霸"] 
        }
    },
    "皇家騎士團": { 
        "核心": { 
            1: "騎士", 
            2: ["聖魂騎士", "烈焰巫師", "破風使者", "暗夜行者", "閃雷悍將"], 
            3: ["聖魂騎士(三轉)", "烈焰巫師(三轉)", "破風使者(三轉)", "暗夜行者(三轉)", "閃雷悍將(三轉)"],
            4: ["聖魂劍士", "烈焰巫師(四轉)", "破風使者(四轉)", "暗夜行者(四轉)", "閃雷悍將(四轉)"] 
        } 
    },
    "超越者": { 
        "超越者": { 1: "神之子", 2: ["神之子(β)"], 3: ["神之子(α)"], 4: ["神之子(超越)"] } 
    },
    "朋友世界": { 
        "超能力": { 1: "凱內西斯", 2: ["凱內西斯(二階)"], 3: ["凱內西斯(三階)"], 4: ["凱內西斯(四階)"] } 
    }
};

// 仙境系列職業樹 (RO)
const JOB_RO = {
    "劍士系": {
        "劍士": { 
            1: "劍士", 
            2: ["騎士", "十字軍"], 
            3: ["騎士領主", "聖殿十字軍"], 
            4: ["盧恩騎士", "皇家禁衛隊"] 
        }
    },
    "魔法師系": {
        "魔法師": { 
            1: "魔法師", 
            2: ["巫師", "賢者"], 
            3: ["超魔導師", "智者"], 
            4: ["咒術士", "妖術師"] 
        }
    },
    "弓箭手系": {
        // 為了二轉鎖定邏輯，整合為一個 Group 的三個分支
        "弓箭手": { 
            1: "弓箭手", 
            2: ["獵人", "詩人", "舞孃"], 
            3: ["神射手", "搞笑藝人", "冷豔舞姬"], 
            4: ["遊俠", "宮廷樂師", "浪跡舞者"] 
        }
    },
    "商人系": {
        "商人": { 
            1: "商人", 
            2: ["鐵匠", "鍊金術士"], 
            3: ["神工匠", "創造者"], 
            4: ["機匠", "基因學者"] 
        }
    },
    "盜賊系": {
        "盜賊": { 
            1: "盜賊", 
            2: ["刺客", "流氓"], 
            3: ["十字刺客", "神行太保"], 
            4: ["十字斬首者", "魅影追蹤者"] 
        }
    },
    "服事系": {
        "服事": { 
            1: "服事", 
            2: ["牧師", "武道家"], 
            3: ["神官", "武術宗師"], 
            4: ["大主教", "修羅"] 
        }
    }
};

const RELIC_DB = [
    { n: "破碎魔法石", d: "全體攻擊力加成 2%" }, { n: "敏捷之靴", d: "自動攻擊頻率優化" },
    { n: "黃金羅盤", d: "擊殺金幣加成 5%" }, { n: "智慧卷軸", d: "SP恢復效率提升" },
    { n: "勇者勳章", d: "主角點擊威力提升" }, { n: "工匠鐵鎚", d: "升級消耗降低 1%" },
    { n: "幸運硬幣", d: "鑽石掉落機率提升" }, { n: "靈魂之罐", d: "助手攻擊力提升" },
    { n: "守望者盾", d: "關卡金幣加成 4%" }, { n: "虛空晶石", d: "技能冷卻短縮" },
    { n: "楓之徽章", d: "基礎傷害 +5%" }, { n: "水晶球殘骸", d: "BOSS 額外鑽石 +1" },
    { n: "古老卷軸", d: "技能持續時間 +2s" }, { n: "貓眼石手鐲", d: "暴擊率 +1%" },
    { n: "冒險指南", d: "永久攻擊加成" }, { n: "生鏽鐵劍", d: "劍士類傷害提升" },
    { n: "斷裂法杖", d: "法師類傷害提升" }, { n: "腐朽長弓", d: "弓箭手傷害提升" },
    { n: "破碎拳刃", d: "盜賊類傷害提升" }, { n: "受損火槍", d: "海盜類傷害提升" },
    { n: "世界樹種子", d: "SP 恢復提升" }, { n: "黑暗結晶", d: "怪物生命降低" },
    { n: "黃金楓葉", d: "金幣掉落提升" }, { n: "扎昆手臂", d: "挑戰時間增加" },
    { n: "皮卡丘電袋", d: "機率麻痺怪物" }, { n: "雪吉拉毛", d: "暴擊威力提升" },
    { n: "龍王項鍊", d: "等級貢獻翻倍" }, { n: "公會旗幟", d: "助手傷加成" },
    { n: "時光沙漏", d: "技能 CD 減免" }, { n: "不朽傳承", d: "轉職倍率加成" }
];

const SKILL_DB = [
    { n: "慧心一擊", d: "造成超高額傷害", cost: 10, cd: 8, val: 100 }, 
    // Buff 類技能 CD 固定 90s，持續時間會隨等級成長
    { n: "致命爆擊", d: "提升爆擊機率，爆擊2倍傷", cost: 10, cd: 90, val: 0.005, dur: 30 },
    { n: "奮力狂擊", d: "提升總攻擊倍率", cost: 10, cd: 90, val: 2, dur: 30 },
    { n: "影分身",   d: "持續時間內總傷害雙倍", cost: 15, cd: 90, val: 2, dur: 30 }
];


// === [區塊 2] 數值成長公式 (Math - 防呆處理) ===

function getMonsterHp(stage) { 
    stage = Math.max(1, stage || 1);
    return 50 * Math.pow(1.16, stage - 1); 
}

function getMonsterCoin(stage) { 
    stage = Math.max(1, stage || 1);
    return 10 * Math.pow(1.16, stage - 1); 
}

function getPlayerCost(lv) { 
    lv = Math.max(1, lv || 1);
    return 10 * Math.pow(1.15, lv - 1); 
}

function getPlayerDmg(lv) { 
    lv = Math.max(1, lv || 1);
    return 5 * Math.pow(1.16, lv - 1); 
}

// 助手升級費用：受轉職階級倍率影響
// Tier Mult: 1轉(5), 2轉(10), 3轉(20), 4轉(50)
function getHelperCost(lv, tierMult) { 
    lv = Math.max(1, lv || 1);
    tierMult = tierMult || 1;
    return 10 * tierMult * Math.pow(1.15, lv - 1); 
}

// 助手傷害
function getHelperDmg(lv, tierMult) { 
    lv = Math.max(1, lv || 1);
    tierMult = tierMult || 1;
    return 2 * tierMult * Math.pow(1.16, lv - 1); 
}

// 技能 SP 消耗
function getSkillCost(i, lv) {
    lv = Math.max(1, lv || 1);
    if (lv <= 1) return SKILL_DB[i].cost;
    let base = SKILL_DB[i].cost;
    let max = 100;
    let cost = base + ((lv - 1) * (max - base) / 99);
    return Math.floor(Math.min(max, cost));
}

// 最大 SP
function getMaxSP(lv) { 
    lv = Math.max(1, lv || 1);
    return Math.min(400, 10 + (lv - 1) * 2); 
}

// 數字格式化
function f(n) { 
    if (!n || isNaN(n)) return "0";
    if (n < 10000) return Math.floor(n).toLocaleString(); 
    const u=["K","M","B","T","q","Q","s","S","O","N"]; 
    let i=-1, d=n; 
    while(d>=1000 && i<u.length-1){ d/=1000; i++; } 
    return d.toFixed(2)+u[i]; 
}
